 #include("/common/include/pageTitleBread.html")
<div id="page-content">
	<div class="col-lg-12">
		<div class="panel">
			<div class="panel-heading">
				#if(o!=null)
				<h3 class="panel-title">编辑用户</h3>
				#else
				<h3 class="panel-title">添加新用户</h3>
				#end
			</div>
			<form id="editForm" class="panel-body form-horizontal form-padding">
		                
		        <input type="hidden" id="id" name="sysUser.id" class="form-control" value="#(o?o.id:'')">
				<div class="form-group">
					<label class="col-md-3 control-label" for="demo-text-input">账号</label>
					<div class="col-md-9">
						<input type="text" name="sysUser.username" class="form-control"
							value="#(o?o.username:'')">
					</div>
				</div>
				<div class="form-group">
					<label class="col-md-3 control-label" for="demo-text-input">密码</label>
					<div class="col-md-9">
						<input type="password" name="sysUser.password"
							class="form-control" value=""
							#if(o) placeholder="如果您不想修改密码,请将此项留空!" #end>
					</div>
				</div>
				<div class="form-group">
					<label class="col-md-3 control-label" for="demo-text-input">密码确认</label>
					<div class="col-md-9">
						<input type="password" name="password2" class="form-control"
							value="" #if(o) placeholder="如果您不想修改密码,请将此项留空!" #end>
					</div>
				</div>
				<div class="form-group">
					<label class="col-md-3 control-label" for="demo-text-input">昵称</label>
					<div class="col-md-9">
						<input type="text" name="sysUser.name" class="form-control"
							value="#(o?o.name:'')">
					</div>
				</div>
				<div class="form-group">
					<label class="col-md-3 control-label" for="demo-text-input">角色</label>
					<div class="col-md-2">
						<select name="sysUser.roleid" class="form-control";>
							
							#for(r:roleList)
							
							#if(o==null)
								<option value="#(r.id)" #if(r.name== "村级管理员") selected="selected" #else  #end>#(r.name)</option>
							#else
								<option value="#(r.id)" #if(o&&o.roleid == r.id) selected="selected" #else  #end>#(r.name)</option>
							#end
							
							#end	
						</select>
					</div>
				</div>
				
				<div class="form-group">
					<label class="col-md-3 control-label" for="demo-text-input">所属机构</label>
					<div class="col-md-4">
							<input type="text" id="orgName" name="sysUser.orgName" class="form-control" readonly="readonly"  value="#(org?org.Name:'')">
							<input type="hidden" id="orgId" name="sysUser.orgid" class="form-control"  value="#(o?o.orgid:'')">
							<input type="hidden" id="areaCode" name="sysUser.areaCode" class="form-control"  value="#(o?o.areaCode:'')">
					</div>
					<span class="input-group-btn">
									<button class="btn btn-mint" type="button" onclick="giveOrg()">选择</button>
					</span>
				</div>


				<div class="form-group">
					<label class="col-md-3 control-label" for="demo-text-input">性别</label>
					<div class="col-md-9">
						<input id="sysUserSexMan" class="magic-radio" type="radio"
							name="sysUser.sex" value="1" #if(o&&o.sex== "1") checked #end>
						<label for="sysUserSexMan">男</label> <input id="sysUserSexWoman"
							class="magic-radio" type="radio" name="sysUser.sex" value="0"
							#if(o&&o.sex== "0") checked #end> <label
							for="sysUserSexWoman">女</label>
					</div>
				</div>
				<div class="form-group">
					<label class="col-md-3 control-label" for="demo-text-input">移动电话</label>
					<div class="col-md-9">
						<input type="text" name="sysUser.mobile" class="form-control"
							value="#(o?o.mobile:'')"> <small class="help-block">请输入移动电话</small>
					</div>
				</div>
				<div class="form-group">
					<label class="col-md-3 control-label" for="demo-text-input">邮箱地址</label>
					<div class="col-md-9">
						<input type="text" name="sysUser.email" class="form-control"
							value="#(o?o.email:'')"> <small class="help-block">请输入邮箱地址</small>
					</div>
				</div>
				<div class="form-group">
					<label class="col-md-3 control-label" for="demo-text-input">身份证号</label>
					<div class="col-md-9">
						<input type="text" name="sysUser.idcard" class="form-control"
							value="#(o?o.idcard:'')"> <small class="help-block">请输入身份证号</small>
					</div>
				</div>
				<div class="form-group">
					<label class="col-md-3 control-label" for="demo-text-input">是否是管理员</label>
					<div class="col-md-9">
						<input id="sysUserIsAdmin" class="magic-radio" type="radio" value="0" name="sysUser.is_admin" #if(o&&o.is_admin=='0') checked="checked" #end> 
						<label for="sysUserIsAdmin">否</label> 
						<input id="sysUserIsNotAdmin" class="magic-radio" type="radio" value="1" name="sysUser.is_admin" #if(o&&o.is_admin=='1') checked="checked" #end> 
						<label for="sysUserIsNotAdmin">是</label>
					</div>
				</div>
				<div class="panel-footer">
					<div class="row">
						<div class="col-sm-9 col-sm-offset-3">
						#if(o)
							<a id="back" class="btn btn-info data-toolbar" onclick="doPjax('#(ctx)/admin/usermanage/getDraftListPage')" href="javascript:void(0);">返回</a>
							<button class="btn btn-warning" type="reset" style="display: none">重置</button> <!-- 保证a标签的位置 -->
						#else
							<button class="btn btn-warning" type="reset">重置</button>
						#end
							<button class="btn btn-mint" type="submit">保存</button>
						</div>
					</div>
				</div>
			</form>
		</div>
	</div>
</div>
<script>
		
var giveOrgIframe;
function giveOrg(){
	var index = layer.open({
				  type: 2,
				  title: false, //不显示标题栏
				  area: ['370px', '650px'],
				  shade: 0.8,
				  id: 'selectOneMenu', //设定一个id，防止重复弹出
				  resize: false,
				  closeBtn: false,
				  isOutAnim : false , 
				  btn: ['确定', '取消'], 
				  btnAlign: 'c',
				  content: ctx+'/admin/psourcemanage/getGiveOrgPage',
				  success: function(layero){
					  giveOrgIframe = window[layero.find('iframe')[0]['name']];
				  },
				  yes: function(index,layero){
					  	var nodes  = giveOrgIframe.getCheckedNodes();
					    //console.log(nodes);
					  	$.post(
								ctx+"/admin/psourcemanage/getChosen", //url
								{nodes:nodes},
								function(data){
									if(data!=null){
										$("#orgId").val(data.id);
										$("#orgName").val(data.name);
										$("#areaCode").val(data.areaCode);
									}
								},
								"json" //数据格式
							);
					  	layer.closeAll(); 
				  }
	});
}
	
		var ifEdit = "#(o?'1':'0')";//是否是修改页面
		var validPassword = {};//密码1
		var validPassword2 = {};//密码2
		var validUsername = {};//用户名 唯一性校验
		if(ifEdit=='1'){//如果是修改 , 密码可以为空
			validPassword = {
                stringLength: {
                    max: 15,
                    message: '*密码长度必须小于15'
                }
            };
			validPassword2 = {
                stringLength: {
                    max: 15,
                    message: '*确认密码长度必须小于15'
                },
                identical: {
                	field: 'sysUser.password',
                	message: '*两次输入密码不一致'
                }
            };
			validUsername = {
                notEmpty: {
                    message: '*用户名不能为空'
                },
                stringLength: {
                    max: 15,
                    message: '*用户名长度必须小于15'
                }
            }
		}else{//新增的
				validPassword = {
	                notEmpty: {
	                    message: '*密码不能为空'
	                },
	                stringLength: {
	                    max: 15,
	                    message: '*密码长度必须小于15'
	                }
	            }
				
				validPassword2 = {
	                notEmpty: {
	                    message: '密码不能为空'
	                },
	                stringLength: {
	                    max: 15,
	                    message: '*确认密码长度必须小于15'
	                },
	                identical: {
	                	field: 'sysUser.password',
	                	message: '*两次输入密码不一致'
	                }
	            }
		
				validUsername = {
	                notEmpty: {
	                    message: '*账号不能为空'
	                },
	                stringLength: {
	                    max: 15,
	                    message: '*用户名长度必须小于15'
	                },
	                remote: {
	                    message: '*账号已被注册',
	                    url:ctx+'/admin/usermanage/validUsername',
	                    delay:1000
	                }
		        }
		}
		/*function selectOneOrg(){
			//调用选择一个单位组件
			pointLion.selectOneOrg(function(orgNode){
				var thisId = $("#orgId").val();//主键
				$("#orgname").val(orgNode.name);//所选单位名称
				$("#orgid").val(orgNode.id);//所选单位id
				
			});
		} */
		function save(){
			var data = common_ajax.ajaxFunc("/admin/usermanage/save", $('#editForm').serialize(), "json", null);
			if(data.success){
				pointLion.alertMsg("保存成功!" , "success" , "small" , function(){
					doPjax(ctx+'/admin/usermanage/getDraftListPage');//跳转到列表页
				});
			}
		}
		$(document).ready(function() {
		    $('#editForm').bootstrapValidator({
		    		excluded:[":hidden"],//关键配置，表示只对于隐藏域不进行验证，其他的表单元素都要验证
		            fields: {
		            	/* "sysUser.orgName":{
		            		validators: {
				                notEmpty: {
				                    message: '*所属单位不能为空'
				                }
				            }
		            	}, */
		            	"sysUser.username": {
						    validators: validUsername
		                },
		                "sysUser.password": {
						    validators: validPassword
		                },
		                "password2": {
						    validators: validPassword2
		                },
		                "sysUser.name": {
						    validators: {
				                notEmpty: {
				                    message: '*用户姓名不能为空'
				                },
				                stringLength: {
				                    max: 15,
				                    message: '*确认密码长度必须小于15'
				                }
				            }
		                },
		                "sysUser.mobile": {
						    validators: {
						    	regexp: {
									regexp: /^1(3|4|5|7|8)\d{9}$/,
									message: '*移动电话格式不对'
								}
				            }
		                },
		                "sysUser.email": {
						    validators: {
						    	regexp: {
									regexp: /^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+(.[a-zA-Z0-9_-])+/ ,
									message: '*邮箱格式不对'
								},
								stringLength: {
				                    max: 100,
				                    message: '*您的邮箱地址也太长了吧'
				                }
				            }
		                },
		                "sysUser.idcard": {
						    validators: {
						    	regexp: {
									regexp: /^(\d{15}$|^\d{18}$|^\d{17}(\d|X|x))$/ ,
									message: '*身份证号格式不对'
								}
				            }
		                }
		            }
		        }).on("success.form.bv", function (e) {
		            save();
		            return false;//阻止表单跳转
		        });
		});
	</script>